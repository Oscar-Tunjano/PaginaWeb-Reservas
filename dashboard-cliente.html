<script>
// ==========================================
//   CONFIGURACIÓN BACKEND REAL
// ==========================================
const API = "https://reservas-backend-sm.onrender.com";


// ==========================================
//   VERIFICAR SESIÓN DEL CLIENTE
// ==========================================
const email = localStorage.getItem("userEmail");
let role = localStorage.getItem("userRole");

// si el usuario NO tiene rol, lo asumimos como cliente
if (!role) {
  role = "cliente";
  localStorage.setItem("userRole", "cliente");
}

if (!email) {
  alert("Debes iniciar sesión.");
  window.location.href = "login.html";
}

if (role !== "cliente") {
  alert("Acceso no permitido.");
  window.location.href = "unauthorized.html";
}

<header>
  <h2>Panel del Cliente</h2>

  <div id="roleImage"></div> <!-- ← AGREGAR ESTO -->

  <nav>
      <a href="index.html">Inicio</a>
      <a href="booknow.html">Reservar</a>
      <a href="dashboard-cliente.html">Mis Reservas</a>
      <button onclick="logout()">Cerrar sesión</button>
  </nav>
</header>

// ==========================================
//   FORMATEAR FECHA
// ==========================================
function formatearFecha(fecha) {
  if (!fecha) return "--";
  return new Date(fecha).toLocaleDateString("es-CO");
}


// ==========================================
//   CARGAR RESERVAS
// ==========================================
async function cargarReservas() {
  const tbody = document.querySelector("#reservasTable tbody");

  tbody.innerHTML = "<tr><td colspan='6'>Cargando reservas...</td></tr>";

  try {
    // RUTA CORRECTA DEL BACKEND
    const response = await fetch(`${API}/api/reservas/user/${email}`, {
      credentials: "include"
    });

    if (response.status === 401) {
      alert("Tu sesión expiró. Inicia sesión nuevamente.");
      window.location.href = "login.html";
      return;
    }

    if (!response.ok) {
      tbody.innerHTML = `<tr><td colspan="6">No se pudieron cargar las reservas.</td></tr>`;
      return;
    }

    const reservas = await response.json();
    tbody.innerHTML = "";

    if (!Array.isArray(reservas) || reservas.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6">No tienes reservas registradas.</td></tr>`;
      return;
    }

    reservas.forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${formatearFecha(r.fecha_inicio)}</td>
        <td>${formatearFecha(r.fecha_fin)}</td>
        <td>${r.propiedad}</td>
        <td>${r.estado}</td>
        <td>
          <button class="cancelar-btn" onclick="cancelarReserva(${r.id})">
            Cancelar
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error("Error cargando reservas:", error);
    tbody.innerHTML = `<tr><td colspan="6">Error al conectar con el servidor.</td></tr>`;
  }
}


// ==========================================
//   CANCELAR RESERVA
// ==========================================
async function cancelarReserva(id) {
  if (!confirm(`¿Seguro que deseas cancelar la reserva #${id}?`)) return;

  try {
    // RUTA CORRECTA DEL BACKEND
    const response = await fetch(`${API}/api/reservas/${id}`, {
      method: "DELETE",
      credentials: "include"
    });

    if (!response.ok) {
      alert("Error al cancelar la reserva.");
      return;
    }

    alert("Reserva cancelada correctamente.");
    cargarReservas();

  } catch (err) {
    console.error(err);
    alert("Error al conectar con el servidor.");
  }
}


// ==========================================
//   CERRAR SESIÓN
// ==========================================
function logout() {
  fetch(`${API}/api/auth/logout`, {
    method: "POST",
    credentials: "include"
  }).finally(() => {
    localStorage.removeItem("userEmail");
    localStorage.removeItem("userRole");
    window.location.href = "index.html";
  });
}


// ==========================================
//   IMAGEN ROL
// ==========================================
document.getElementById("roleImage").innerHTML = `
  <svg width="100" height="60" xmlns="http://www.w3.org/2000/svg">
    <rect width="100" height="60" fill="#29f" />
    <text x="50" y="35" font-size="12" text-anchor="middle" fill="#fff">
      CLIENTE
    </text>
  </svg>
`;


// ==========================================
//   INICIAR
// ==========================================
cargarReservas();
</script>
