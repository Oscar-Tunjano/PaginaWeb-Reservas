<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mis Reservas - Panel Cliente</title>

  <style>
    body { font-family: Arial; background:#f2f2f2; margin:0; padding:0; }
    header { background:#0b6797; color:white; padding:15px; }
    nav a, nav button {
      color:white; margin-right:12px; text-decoration:none; font-weight:bold;
    }
    nav button {
      background:transparent; border:none; cursor:pointer;
    }
    section { padding:20px; }
    table {
      width:100%;
      border-collapse:collapse;
      background:white;
      margin-top:20px;
    }
    th, td { padding:10px; border:1px solid #ccc; }
    th { background:#e3e3e3; }
    .cancelar-btn {
      background:#d9534f;
      color:white;
      border:none;
      padding:8px;
      cursor:pointer;
      border-radius:4px;
    }
  </style>
</head>

<body>

<header>
  <h2>Panel del Cliente</h2>

  <nav>
    <a href="index.html">Inicio</a>
    <a href="booknow.html">Reservar</a>
    <a href="dashboard-cliente.html">Mis Reservas</a>
    <button onclick="logout()">Cerrar sesión</button>
  </nav>
</header>

<section>
  <h3>Mis Reservas</h3>

  <table id="reservasTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Check-in</th>
        <th>Check-out</th>
        <th>Propiedad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Cargando reservas...</td></tr>
    </tbody>
  </table>
</section>

<script>
const API = "https://reservas-backend-sm.onrender.com";

// ======================================================
//   VALIDAR SESIÓN (SOLO TOKEN)
// ======================================================
function verificarSesion() {
  const token = localStorage.getItem("token");
  const usuario = localStorage.getItem("usuario");

  if (!token || !usuario) {
    alert("Debes iniciar sesión.");
    window.location.href = "login.html";
    return false;
  }
  return true;
}

verificarSesion();

// ======================================================
//  FORMATEAR FECHA
// ======================================================
function formatearFecha(f) {
  return new Date(f).toLocaleDateString("es-CO");
}

// ======================================================
//  CARGAR RESERVAS DEL USUARIO (USANDO /api/mis-reservas)
// ======================================================
async function cargarReservas() {
  const token = localStorage.getItem("token");
  const tbody = document.querySelector("#reservasTable tbody");

  tbody.innerHTML = "<tr><td colspan='5'>Cargando reservas...</td></tr>";

  try {
    const res = await fetch(`${API}/api/mis-reservas`, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    if (!res.ok) {
      tbody.innerHTML = "<tr><td colspan='5'>Error obteniendo reservas.</td></tr>";
      return;
    }

    const reservas = await res.json();

    if (!reservas.length) {
      tbody.innerHTML = "<tr><td colspan='5'>No tienes reservas aún.</td></tr>";
      return;
    }

    tbody.innerHTML = "";

    reservas.forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${formatearFecha(r.fecha_inicio)}</td>
        <td>${formatearFecha(r.fecha_fin)}</td>
        <td>${r.propiedad}</td>
        <td>
          <button class="cancelar-btn" onclick="cancelarReserva(${r.id})">Cancelar</button>
        </td>
      `;

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("ERROR:", err);
    tbody.innerHTML = "<tr><td colspan='5'>Error conectando al servidor.</td></tr>";
  }
}

// ======================================================
//   CANCELAR RESERVA (DELETE /api/reservas/:id)
// ======================================================
async function cancelarReserva(id) {
  if (!confirm(`¿Cancelar la reserva #${id}?`)) return;

  const token = localStorage.getItem("token");

  try {
    const res = await fetch(`${API}/api/reservas/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    if (!res.ok) {
      alert("Error al cancelar la reserva.");
      return;
    }

    alert("Reserva cancelada correctamente.");
    cargarReservas();

  } catch (err) {
    alert("Error en el servidor.");
    console.error(err);
  }
}

// ======================================================
//   LOGOUT
// ======================================================
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// ======================================================
//   INICIO
// ======================================================
cargarReservas();
</script>

</body>
</html>