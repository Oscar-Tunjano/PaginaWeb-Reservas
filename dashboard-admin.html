<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Panel Administrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { font-family: Arial; background:#f3f3f3; margin:0; }
        header {
            background:#c62828; color:white; padding:15px;
            display:flex; justify-content:space-between; align-items:center;
        }
        nav a, nav button {
            color:white; font-weight:bold; margin-right:12px;
            text-decoration:none; background:none; border:none; cursor:pointer;
        }
        section { padding:20px; }
        table { width:100%; border-collapse:collapse; background:white; }
        th, td { padding:10px; border:1px solid #ccc; }
        th { background:#e0e0e0; }
        button { padding:6px 10px; border:none; cursor:pointer; border-radius:4px; }
        .aprobar { background:#2e7d32; color:white; }
        .rechazar { background:#d32f2f; color:white; }
        .eliminar { background:#6a1b9a; color:white; }
    </style>
</head>
<body>

<header>
    <div>
        <h2 style="margin:0;">Panel Administrador</h2>
        <div id="roleImage"></div>
    </div>

    <nav>
        <a href="index.html">Inicio</a>
        <a href="dashboard-admin.html">Reservas</a>
        <button onclick="logout()">Cerrar sesión</button>
    </nav>
</header>

<section>
    <h3>Gestión de Reservas</h3>

    <table id="reservasTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Propiedad</th>
                <th>Usuario</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="7">Cargando reservas...</td></tr>
        </tbody>
    </table>
</section>

<script>
const API = "https://reservas-backend-sm.onrender.com";
const token = localStorage.getItem("token");
const role  = localStorage.getItem("userRole");

// ==========================================
//  PROTEGER ACCESO
// ==========================================
if (!token || role !== "admin") {
    alert("Acceso no autorizado.");
    window.location.href = "unauthorized.html";
    throw new Error("No autorizado");
}

// ==========================================
//  FORMATEAR FECHA
// ==========================================
function fmt(f) {
    return new Date(f).toLocaleDateString("es-CO");
}

// ==========================================
//  CARGAR RESERVAS (CON TOKEN)
// ==========================================
async function cargarReservas() {
    const tbody = document.querySelector("#reservasTable tbody");
    tbody.innerHTML = "<tr><td colspan='7'>Cargando...</td></tr>";

    try {
        const res = await fetch(`${API}/api/admin/reservas`, {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) {
            tbody.innerHTML = "<tr><td colspan='7'>Error al cargar reservas</td></tr>";
            return;
        }

        const reservas = await res.json();
        tbody.innerHTML = "";

        if (!reservas.length) {
            tbody.innerHTML = "<tr><td colspan='7'>No hay reservas.</td></tr>";
            return;
        }

        reservas.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${r.id}</td>
                <td>${r.propiedad}</td>
                <td>${r.usuario}</td>
                <td>${fmt(r.fecha_inicio)}</td>
                <td>${fmt(r.fecha_fin)}</td>
                <td>${r.estado}</td>
                <td>
                    <button class="aprobar" onclick="cambiarEstado(${r.id}, 'aprobada')">Aprobar</button>
                    <button class="rechazar" onclick="cambiarEstado(${r.id}, 'rechazada')">Rechazar</button>
                    <button class="eliminar" onclick="eliminarReserva(${r.id})">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='7'>Error en el servidor</td></tr>";
    }
}

// ==========================================
//  CAMBIAR ESTADO (PUT CON TOKEN)
// ==========================================
async function cambiarEstado(id, estado) {
    if (!confirm(`¿Cambiar estado de reserva #${id} a ${estado}?`)) return;

    const res = await fetch(`${API}/api/admin/reservas/${id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ estado })
    });

    if (res.ok) {
        alert("Estado actualizado");
        cargarReservas();
    } else {
        alert("No se pudo actualizar");
    }
}

// ==========================================
//  ELIMINAR RESERVA (DELETE CON TOKEN)
// ==========================================
async function eliminarReserva(id) {
    if (!confirm(`¿Eliminar reserva #${id}?`)) return;

    const res = await fetch(`${API}/api/admin/reservas/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    if (res.ok) {
        alert("Reserva eliminada");
        cargarReservas();
    } else {
        alert("No se pudo eliminar");
    }
}

// ==========================================
//  LOGOUT (SIN API, PORQUE USAS JWT)
// ==========================================
function logout() {
    localStorage.clear();
    window.location.href = "index.html";
}

// ==========================================
//  ICONO ADMIN
// ==========================================
document.getElementById("roleImage").innerHTML = `
  <svg width="100" height="50">
      <rect width="100" height="50" fill="#c62828"></rect>
      <text x="50" y="30" font-size="14" text-anchor="middle" fill="#fff">ADMIN</text>
  </svg>
`;

cargarReservas();
</script>

</body>
</html>